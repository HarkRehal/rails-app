#!/bin/bash

echo "üöÄ Rails App EC2 Deployment Commands"
echo "===================================="
echo ""

echo "üìã STEP 1: Install Docker (if not already installed)"
echo "sudo yum update -y"
echo "sudo yum install -y docker git"
echo "sudo systemctl start docker"
echo "sudo systemctl enable docker"
echo "sudo usermod -a -G docker ec2-user"
echo ""

echo "üìã STEP 2: Install Docker Compose"
echo "sudo curl -L \"https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose"
echo "sudo chmod +x /usr/local/bin/docker-compose"
echo ""

echo "üìã STEP 3: Clone and Deploy Your App"
echo "sudo mkdir -p /opt/rails-app"
echo "sudo chown ec2-user:ec2-user /opt/rails-app"
echo "cd /opt/rails-app"
echo ""
echo "# Replace YOUR_USERNAME with your GitHub username:"
echo "git clone https://github.com/YOUR_USERNAME/rails-app.git ."
echo ""
echo "# Generate production secrets"
echo "./generate_secrets.sh"
echo ""
echo "# Deploy the application"
echo "docker-compose -f docker-compose.production.yml build"
echo "docker-compose -f docker-compose.production.yml run --rm web rails db:create db:migrate"
echo ""
echo "# Create initial user"
echo "docker-compose -f docker-compose.production.yml run --rm web rails runner \""
echo "User.find_or_create_by(email: 'admin@harkirehal.com') do |user|"
echo "  user.password = 'changeme123'"
echo "end"
echo ""
echo "Resume.find_or_create_by(id: 1) do |resume|"
echo "  resume.name = 'Harki Rehal'"
echo "  resume.title = 'AI & Technology Professional'"
echo "  resume.summary = 'Visionary global sales engineering leader with 20+ years of experience.'"
echo "end\""
echo ""
echo "# Start the application"
echo "docker-compose -f docker-compose.production.yml up -d"
echo ""

echo "üìã STEP 4: Update Nginx Configuration"
echo "sudo nano /etc/nginx/sites-available/default"
echo "# OR"
echo "sudo nano /etc/nginx/nginx.conf"
echo ""
echo "Add this BEFORE your existing server block:"
echo "upstream rails_app {"
echo "    server localhost:3001;"
echo "}"
echo ""
echo "Add these INSIDE your existing server block:"
echo "location = / {"
echo "    proxy_pass http://rails_app;"
echo "    proxy_set_header Host \$host;"
echo "    proxy_set_header X-Real-IP \$remote_addr;"
echo "    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;"
echo "    proxy_set_header X-Forwarded-Proto \$scheme;"
echo "}"
echo ""
echo "location ~ ^/(login|resume|posts|logout) {"
echo "    proxy_pass http://rails_app;"
echo "    proxy_set_header Host \$host;"
echo "    proxy_set_header X-Real-IP \$remote_addr;"
echo "    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;"
echo "    proxy_set_header X-Forwarded-Proto \$scheme;"
echo "}"
echo ""
echo "üìã STEP 5: Test and Reload Nginx"
echo "sudo nginx -t"
echo "sudo systemctl reload nginx"
echo ""

echo "‚úÖ DEPLOYMENT COMPLETE!"
echo "üåê Visit: https://www.harkirehal.com"
echo "üë§ Login: admin@harkirehal.com / changeme123"
echo "ü§ñ Your /AskAI will still work at: https://www.harkirehal.com/AskAI"